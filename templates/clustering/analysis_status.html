{% extends "clustering/base_analysis.html" %}

{% block title %}BiGAnts-Web analysis status{% endblock %}

{% block custom_css %}
    {% load static %}
    <link href="{% static 'clustering/css/status.css' %}" rel="stylesheet">


    <style>
        ul.no_bullet {
            list-style-type: none;
            padding: 10px;
        }

        li {
            margin: 10px;
        }

        li.empty-circle {
            background: url({% static 'clustering/img/icons/empty-circle.svg' %}) no-repeat left top;
            padding-left: 30px;
            fill: #999FA4;
        }

        li.empty-circle-muted {
            background: url({% static 'clustering/img/icons/empty-circle-muted.svg' %}) no-repeat left top;
            padding-left: 30px;
        }

        li.check-circle {
            background: url({% static 'clustering/img/icons/check-circle-regular.svg' %}) no-repeat left top;
            padding-left: 30px;
        }


    </style>
{% endblock %}


{% block content %}
    <div class="card mt-4">
        <div class="card-body">
            <h1 class="card-title">Analysis Status</h1>
            <div id="alert_success" class="alert alert-success {% if task.status != 'SUCCESS' %} d-none {% endif %}">
                <strong>Success!</strong> Your analysis finished successfully.
                <a href="{% url 'clustering:analysis_result' task.task_id %}" class="alert-link">Click here</a> to
                view the results.
            </div>
            <div id="alert_failure" class="alert alert-danger {% if task.status != 'FAILURE' %} d-none {% endif %}">
                <strong>FAILURE!</strong> Your analysis failed!
                Check the progress bar below and the printed error messages for more information and try to rerun
                you analysis.
            </div>
            <div id="alert_running" class="alert alert-info {% if task.status != 'RUNNING' %} d-none {% endif %}">
                <strong>Running!</strong> Your analysis is running!
                Check the progress bar below for more information.
            </div>
            <div id="alert_pending" class="alert alert-info {% if task.status != 'PENDING' %} d-none {% endif %}">
                <strong>Pending!</strong> Your job is currently in a queue. The analysis will start
                in a few moments.
            </div>


            <div class="card" style="border: none;">
                <div class="card-body mt-1">
                    Progress
                    <div class="progress">
                        {#                    <div class="state one bg-primary"></div>#}
                        {#                    <div class="state two bg-primary"></div>#}
                        {#                    <div class="state three bg-primary"></div>#}
                        {#                    <div class="state four bg-primary"></div>#}
                        {#                    <div class="state five bg-primary"></div>#}
                        <div id="progress-bar" class="progress-bar" style="width: 0%;">0 &#37;</div>
                    </div>

                    {#                <div>#}
                    {#                    <br/><span style="position: absolute; left: -5%;">Submitted</span>#}
                    {#                    <span style="position: absolute; left: 12%;">Expression data</span>#}
                    {#                    <span style="position: absolute; left: 35%;">PPI data</span>#}
                    {#                    <span style="position: absolute; left: 75%;">Clustering</span>#}
                    {#                    <span style="position: absolute; left: 93%;">Visualize</span>#}
                    {#                </div>#}

                </div>
            </div>
            <div class="card" style="border: none;">

                <div class="card mt-3" style="border: none;">

                    <ul class="no_bullet">
                        <li class="process-step check-circle text-success">Submitted</li>
                        <li class="process-step empty-circle-muted text-muted">Preprocess expression data</li>
                        <li class="process-step empty-circle-muted text-muted">Preprocess expression PPI data</li>
                        <li class="process-step empty-circle-muted text-muted">Check input data</li>
                        <li class="process-step empty-circle-muted text-muted">Run clustering algorithm</li>
                        <li class="process-step empty-circle-muted text-muted">Visualize results</li>
                    </ul>
                </div>
            </div>


        </div>
    </div>

    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <script>

        let counter = 0;
        let task_status;
        let progress_step;
        let progress_percent;

        function update_status(csrf_token, task_id, poll_url) {
            // Get task_status via AJAX
            $.ajax({
                url: poll_url,
                type: 'POST',
                data: {
                    task_id: task_id,
                    csrfmiddlewaretoken: csrf_token,
                },
                success: function (result) {
                    task_status = result.task_status;
                    progress_step = result.progress_step;
                    progress_percent = result.progress_percent;
                }
            });

            switch (task_status) {
                case 'RUNNING':
                    show_only_alert('alert_running');
                    $('#progress-bar').html(progress_percent + '% ')
                    $('#progress-bar').css('width', progress_percent + '%')

                    display_step(progress_step)
                    break;

                case 'SUCCESS':
                    show_only_alert('alert_success');
                    $('#progress-bar').html(100 + '% ')
                    $('#progress-bar').css('width', 100 + '%')

                    display_step('visualize_data')
                    break;

                case 'FAILURE':
                    show_only_alert('alert_failure');

                    style_steps(progress_step)
                    break;

                case 'PENDING':
                    show_only_alert('alert_pending');
                    break;


            }


            {#console.log(counter);#}

            // Update graph and text while the process is running
            if (!(task_status === 'FAILED' || task_status === 'SUCCESS')) {
                setTimeout(update_status, 2000, csrf_token, task_id, poll_url);
                counter++
            }
        }

        function style_steps(step_number) {
            jQuery('.process-step ').each(function (index, currentElement) {

                // Finished steps
                if (index < step_number) {
                    $(currentElement).removeClass('text-muted').addClass('text-success');
                    $(currentElement).removeClass('empty-circle').addClass('check-circle');

                    // Current step
                } else if (index === step_number) {
                    $(currentElement).removeClass('text-muted');
                    $(currentElement).removeClass('empty-circle-muted').addClass('empty-circle');

                    // Steps ahead
                } else {
                    $(currentElement).removeClass('text-success').addClass('text-muted');
                    $(currentElement).removeClass('check-circle').addClass('empty-circle-muted');

                }

            });
        }

        function display_step(step_name) {
            switch (step_name) {
                case 'submitted':
                    style_steps(1);
                    break;

                case 'expression_data':
                    style_steps(2);
                    break;

                case 'ppi_data':
                    style_steps(3);
                    break;

                case 'validate_preprocess_data':
                    style_steps(4);
                    break;

                case 'run_clustering':
                    style_steps(5);
                    break;

                case 'visualize_data':
                    style_steps('6');
                    break;
            }
        }

        function show_only_alert(alert_id) {
            $('.alert').each(function () {
                const alert = $(this);

                // Block every other alert
                if (alert.attr('id') !== alert_id) {
                    alert.addClass('d-none')

                    // Show selected alert
                } else {
                    alert.removeClass('d-none')
                }
            })
        }

        // Run the update task_status function
        update_status('{{ csrf_token }}', '{{ task.id }}', '{% url 'clustering:poll_status' %}')
    </script>
{% endblock %}